{% extends 'base_dar.html' %}

{% load deputags %}
{% load dartags %}
{% load if_tag %}

{% block extrabodyclass %}default dar{% endblock %}

{% block title %}{{ day.date }} &mdash; Demo.cratica (Beta){% endblock %}

{% block ogtitle %}{{ day.date }} &mdash; Demo.cratica (Beta){% endblock %}
{% block ogurl %}{% url day_detail day.date.year day.date.month day.date.day %}{% endblock %}
{% block ogtype %}transcript{% endblock %}

{% block extrascripts %}
    <script src="/media/js/jquery.jeditable.mini.js" type="text/javascript"></script>
    <script src="/media/js/truncatable/jquery.truncatable.js" type="text/javascript"></script>
    <script src="https://static.ak.fbcdn.net/connect.php/js/FB.Share" type="text/javascript"></script>
    <script type="text/javascript">

        // faz o reparse uma entrada individual
        function refresh(id) {
          // loading gif 
          $('.entry#' + id).html('<img src="/media/img/loading.gif" />');
          $.ajax({
            url: '/sessoes/reprocessar/' + id + '/',
            success: function(data) {
              $('.entry#' + id).html(data);
              console.log(id)
              // FIXME: precisamos de colocar a textarea como editável novamente
              $(".edit_area").editable("/sessoes/gravar/",
                {
                  cancel: "Cancelar",
                  submit: "OK",
                  tooltip: "Clique 2 vezes para fazer alterações.",
                  loadurl: '/sessoes/raw/',
                  type: "textarea",
                  indicator: '<img src="/media/img/loading.gif" />',
                  event: "dblclick",
                  callback : function(value, settings) 
                  {
                    refresh(this.parentNode.id);
                    return value;
                  }
                });
              }
            });
          };

        // vai apenas buscar o valor actual da entrada
        function soft_refresh(id) {
          // loading gif 
          $('.entry#' + id).html('<img src="/media/img/loading.gif" />');
          $.ajax({
            url: '/sessoes/reprocessar/' + id + '/?skip_parsing=1',
          // FIXME: Error response
          success: function(data) {
            $('.entry#' + id).html(data);
            console.log(id)
            // FIXME: precisamos de colocar a textarea como editável novamente
            $(".edit_area").editable("/sessoes/gravar/",
              {
                cancel: "Cancelar",
                submit: "OK",
                tooltip: "Clique 2 vezes para fazer alterações.",
                loadurl: '/sessoes/raw/',
                type: "textarea",
                indicator: '<img src="/media/img/loading.gif" />',
                event: "dblclick",
                callback : function(value, settings) {
                    refresh(this.parentNode.id);
                    return value;
                    }
              });
            }
          });
        };

        function mark_as_cont(id) {
          $.ajax({
            url: '/sessoes/marcar/' + id + '/',
            success: function(data) {
            soft_refresh(id);
            }
          });
        };
        function unmark_as_cont(id) {
          $.ajax({
            url: '/sessoes/desmarcar/' + id + '/',
            success: function(data) {
            soft_refresh(id);
            }
          });
        };
        function mark_as_aside(id) {
          $.ajax({
            url: '/sessoes/marcar_aparte/' + id + '/',
          success: function(data) {
            soft_refresh(id);
            }
          });
        };
        function mark_as_main(id) {
          $.ajax({
            url: '/sessoes/marcar_intervencao/' + id + '/',
          success: function(data) {
            soft_refresh(id);
            }
          });
        };
        function correct_newlines(id) {
          $.ajax({
            url: '/sessoes/newlines/' + id + '/',
          success: function(data) {
            soft_refresh(id);
            }
          });
        };

        function join_with_previous(id, prev_id, next_id) {
          // loading gif 
          $('.entry#' + id).html('<img src="/media/img/loading.gif" />');
          $.ajax({
            url: '/sessoes/juntar/' + id + '/',
            success: function(data) {
              // apagar parent div
              $('.entry#' + id).hide();
              console.log(id)
              soft_refresh(prev_id)
              soft_refresh(next_id)
              // FIXME: precisamos de colocar a textarea como editável novamente
              $(".edit_area").editable("/sessoes/gravar/",
                {
                  cancel: "Cancelar",
                  submit: "OK",
                  tooltip: "Clique 2 vezes para fazer alterações.",
                  loadurl: '/sessoes/raw/',
                  type: "textarea",
                  indicator: '<img src="/media/img/loading.gif" />',
                  event: "dblclick",
                  callback : function(value, settings) 
                  {
                    refresh(this.parentNode.id);
                    return value;
                  }
                });
              }
            });
          };
      $(document).ready(function(){  
        // CSRF protection
        $.ajaxSetup({
          data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
        });

        $(".entry").hover(function(){
          $(this).toggleClass("active");
        });

        // jeditable
        $(".edit_area").editable("/sessoes/gravar/",
          {
            cancel: "Cancelar",
            submit: "OK",
            tooltip: "Clique 2 vezes para fazer alterações.",
            loadurl: '/sessoes/raw/',
            type: "textarea",
            indicator: '<img src="/media/img/loading.gif" />',
            event: "dblclick",
            callback : function(value, settings) {
                refresh(this.parentNode.id);
                return value;
                }
            });

      });
    </script>
    <script type="text/javascript">
      $(document).ready(function() {        
        //$(".actionbar-btn").click(function(){
          //  $(".actionbar-btn").next("ul").slideToggle("slow").toggleClass("open");
           // $(this).toggleClass("open"); return false;
          //});
          
          //fade dropdown
	        $(".entry").hover(function(){
		        $(this).next('ul.actionbar:hidden').fadeIn();
	        },function(){
		        $(this).next('ul.actionbar:first').fadeOut();
	        });
	      $(".collapsible").truncatable({	limit: 100, more: '[Mostrar tudo]', less: true, hideText: '[Esconder]' }); 
	});
  </script>

{% endblock %}

{% block content %}
      <div id="content-box">
        
        <ul id="dar-tabs" class="tabs">
          <li><span>Sessão</span></li>
          <li><a href="stats" title="">Estatísticas</a></li>
        </ul>
         
        <h2 class="ribbon">{{ day.date }}</h2>

        <p><strong>Nota:</strong> As transcrições ainda estão em desenvolvimento. Pode haver inconsistências e erros de processamento.</p>

        {% for entry in entries %}


          {% if forloop.first %}
          <div class="intervention mini-intervention">
          
            <div class="entry">
              <div class="left">olá</div>
              <div class="right vote-result">
                <p>Submetida à votação, foi aprovada, com votos a favor do PSD e do CDS-PP, votos contra do PCP, do BE e de Os Verdes e a abstenção do PS.</p>
              </div>
            </div>
            <div class="entry">
              <div class="left">olá</div>
              <div class="right edit_area collapsible">
                <p>Deputados presentes à sessão:</p>
                 <p>Partido Social Democrata (PSD) Adriano Rafael de Sousa Moreira</p>
                 <p>Adão José Fonseca Silva</p>
                 <p>Afonso Gonçalves da Silva Oliveira</p>
                 <p>Amadeu Albertino Marques Soares Albergaria</p>
                 <p>Ana Sofia Fernandes Bettencourt</p> <p>Andreia Carina Machado da Silva Neto</p> <p>António Carlos Sousa Gomes da Silva Peixoto</p> <p>António Costa Rodrigues</p> <p>António Egrejas Leitão Amaro</p> <p>António Fernando Couto dos Santos</p> <p>António Manuel Pimenta Prôa</p> <p>António Pedro Roque da Visitação Oliveira</p> <p>Arménio dos Santos</p> <p>Bruno Jorge Viegas Vitorino</p> <p>Bruno Manuel Pereira Coimbra</p> <p>Carina João Reis Oliveira</p> <p>Carla Maria de Pinho Rodrigues</p> <p>Carlos Alberto Silva Gonçalves</p> <p>Carlos António Páscoa Gonçalves</p> <p>Carlos Eduardo Almeida de Abreu Amorim</p> <p>Carlos Henrique da Costa Neves</p> <p>Carlos Manuel Faia São Martinho Gomes</p> <p>Carlos Manuel dos Santos Batista da Silva</p> <p>Cláudia Sofia Gomes Monteiro de Aguiar</p> <p>Cristóvão Duarte Nunes Guerreiro Norte</p> <p>Cristóvão Simão Oliveira de Ribeiro</p> <p>Cristóvão da Conceição Ventura Crespo</p> <p>Duarte Filipe Batista de Matos Marques</p> <p>Duarte Rogério Matos Ventura Pacheco</p> <p>Eduardo Alexandre Ribeiro Gonçalves Teixeira</p> <p>Elsa Maria Simas Cordeiro</p> <p>Emídio Guerreiro</p> <p>Emília de Fátima Moreira dos Santos</p> <p>Fernando Luís de Sousa Machado Soares Vales</p> <p>Fernando Mimoso Negrão</p> <p>Fernando Nuno Fernandes Ribeiro dos Reis</p> <p>Fernando Ribeiro Marques</p> <p>Fernando Virgílio Cabral da Cruz Macedo</p> <p>Guilherme Henrique Valente Rodrigues da Silva</p> <p>Hugo Alexandre Lopes Soares</p> <p>Hugo José Teixeira Velosa</p> <p>Hélder António Guerra de Sousa Silva</p> <p>Joana Catarina Barata Reis Lopes</p> <p>Joaquim Carlos Vasconcelos da Ponte</p> <p>Jorge Paulo da Silva Oliveira</p>
              </div>
            </div>
        
          {% endif %}

          {# Verificar se temos de fechar a tag da intervencao anterior #}
          {% if entry.type == 'deputado_intervencao' or entry.type == 'presidente' or entry.type == 'secretario' or entry.type == 'presidente_temapalavra' or entry.type == 'presidente_aberta' or entry.type == 'pm_intervencao' %}
            </div> <!-- /intervention --> 
            {% if entry.type == 'deputado_intervencao' or entry.type == 'pm_intervencao' or entry.type == 'ministro_intervencao' %}
              <div class="intervention">
            {% else %}
              <div class="intervention mini-intervention">
            {% endif %}
          {% endif %}

          <div class="entry" id="{{ entry.id }}">
            {% include 'dar/entry_snippet.html' %}
            
            <ul class="actionbar">
              <li><a href="">Juntar à anterior</a></li>
              <li><a href="">Marcar como continuação</a></li>
            </ul>
            
          </div> <!-- /entry -->
          {% if forloop.last %}
          </div> <!-- /intervention --> 
          {% endif %}

        {% endfor %}
        
        <p class="notice">Versão Beta: Esta informação pode estar incompleta e/ou conter incorrecções.</p>

      </div><!-- /#content-box -->
      
      <div id="toolbar">
        <ul>
          <li><a href="">Abrir PDF original</a></li>
          <li><a href="{% url parse_session_entries day.id %}">{% if day.parsed %}Re-catalogar sessão{% else %}Catalogar sessão{% endif %} (demora um bocadinho)</a></li>
          
          <li><a href="">Logout?</a></li>
        </ul>
      </div><!-- /#toolbar -->
      
{% endblock content %}


